apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: cd-stage-deploy
spec:
  params:
    - name: CDPIPELINE_CR
      description: |
        EDP kind:CDPipeline name used for deployment. For example: mypipe, myfeature
    - name: CDPIPELINE_STAGE
      description: |
        EDP kind:Stage name of the kind:CDPipeline defined in the CDPIPELINE values. For example: dev, test, prod
    - name: APPLICATIONS_PAYLOAD
      description: |
        Applications payload in format: '{"codebase1": "version1", "codebase2": "version2"}. For example: '{"demo": "main-20240103-141431", "myapp": "0.1.0-SNAPSHOT.1"}'
  resourcetemplates:
    - apiVersion: tekton.dev/v1
      kind: PipelineRun
      metadata:
        generateName: deploy-$(tt.params.CDPIPELINE_CR)-$(tt.params.CDPIPELINE_STAGE)-
        labels:
          app.edp.epam.com/cdpipeline: $(tt.params.CDPIPELINE_CR)
          app.edp.epam.com/cdstage: $(tt.params.CDPIPELINE_STAGE)
          app.edp.epam.com/pipelinetype: deploy
      spec:
        taskRunTemplate:
          serviceAccountName: tekton
        pipelineRef:
          name: cd-stage-deploy
        params:
          - name: APPLICATIONS_PAYLOAD
            value: $(tt.params.APPLICATIONS_PAYLOAD)
          - name: CDPIPELINE_STAGE
            value: $(tt.params.CDPIPELINE_STAGE)
          - name: CDPIPELINE_CR
            value: $(tt.params.CDPIPELINE_CR)
        timeouts:
          pipeline: 1h00m0s
